# 📊 数据可视化与噪声分析完整指南

## 🎯 目标

帮助您通过可视化和定量分析来判断数据是否需要去噪处理。

---

## 🚀 快速上手

### Step 1: 基础可视化

```bash
python visualize_raw_data.py
```

**输出文件**:
- `figure/raw_data_time_series.png` - 时间序列图
- `figure/raw_data_distribution.png` - 数据分布图
- `figure/raw_data_correlation.png` - 节点相关性热图

**查看要点**:
1. **时间序列**: 是否平滑连续，有无突变
2. **分布**: 是否接近正态分布，有无长尾
3. **相关性**: 节点间是否有合理的空间关联

---

### Step 2: 深度噪声分析

```bash
python analyze_noise.py
```

**输出文件**:
- `figure/noise_analysis_report.png` - 综合分析报告（4合1）

**报告包含**:
1. **SNR分布图**: 各节点的信噪比
2. **频谱分析**: 低频信号vs高频噪声
3. **异常值检测**: 各节点异常值数量
4. **自相关分析**: 时序模式和噪声

---

## 📖 详细解读

### 1️⃣ 时间序列图

<img src="figure/raw_data_time_series.png" width="800">

**观察重点**:

✅ **良好信号**:
- 曲线平滑连续
- 有明显周期性
- 变化幅度合理

❌ **噪声信号**:
- 频繁毛刺
- 突变/跳变
- 不规则振荡

**示例判断**:
```
如果曲线像这样: ～～～～～～～  → 良好
如果曲线像这样: ∧∨∧∨∧∨∧∨  → 有噪声
```

---

### 2️⃣ SNR分布图

<img src="figure/noise_analysis_report.png" width="800">

**颜色含义**:
- 🟢 绿色 (SNR > 20 dB): 信号质量优秀
- 🟡 黄色 (10-20 dB): 信号质量中等
- 🔴 红色 (SNR < 10 dB): 信号质量较差

**判断标准**:

| 平均SNR | 数据质量 | 建议 |
|---------|---------|------|
| > 25 dB | 优秀 | 不需要去噪 |
| 20-25 dB | 良好 | 可选去噪 |
| 15-20 dB | 中等 | 建议轻量去噪 |
| 10-15 dB | 较差 | 建议去噪 |
| < 10 dB | 差 | 强烈建议强力去噪 |

**控制台输出示例**:
```
平均SNR: 18.32 dB
→ 数据质量中等，建议使用卷积去噪
```

---

### 3️⃣ 频谱分析图

**原理**: 
- 低频 = 真实信号（趋势、周期）
- 高频 = 噪声（随机波动）

**判断标准**:

| 高频能量占比 | 噪声水平 | 建议 |
|-------------|---------|------|
| < 5% | 极低 | 不需要去噪 |
| 5-10% | 低 | 可选去噪 |
| 10-20% | 中等 | 建议去噪 |
| 20-30% | 较高 | 强烈建议去噪 |
| > 30% | 高 | 必须去噪 |

**观察要点**:
```
理想频谱:
功率  ╱╲___________  ← 低频高，高频低
      低 → 高 频率

噪声频谱:
功率  ╱╲╱╲╱╲╱╲╱╲  ← 高频能量高
      低 → 高 频率
```

---

### 4️⃣ 异常值检测

**检测方法**: IQR (四分位距) 方法

**判断标准**:

| 异常值比例 | 数据质量 | 建议 |
|-----------|---------|------|
| < 0.5% | 优秀 | 不需要去噪 |
| 0.5-1% | 良好 | 可选去噪 |
| 1-3% | 中等 | 建议去噪 |
| 3-5% | 较差 | 强烈建议去噪 |
| > 5% | 差 | 必须去噪 |

**控制台输出示例**:
```
异常值比例: 2.34%
→ 有一定异常值，建议去噪
```

---

### 5️⃣ 自相关分析

**作用**: 检测时序模式和噪声影响

**理想模式**:
```
相关系数
1.0  ●
     │╲
0.5  │ ╲___________  ← 平滑衰减
     │
0.0  └──────────────→ 滞后量
     0  10  20  30
```

**噪声模式**:
```
相关系数
1.0  ●
     │╲ ╱╲ ╱╲      ← 快速振荡
0.5  │ ∨  ∨  ╲___
     │
0.0  └──────────────→ 滞后量
     0  10  20  30
```

**判断**:
- 快速衰减 (< 10步) → 噪声较多
- 平滑衰减 (> 20步) → 数据质量好

---

## 🎯 综合决策表

根据所有指标综合判断：

| 噪声评分 | SNR | 高频% | 异常值% | 推荐配置 |
|---------|-----|-------|---------|---------|
| 0-2 | > 20 | < 10 | < 1 | `use_denoising: False` |
| 3-5 | 10-20 | 10-30 | 1-5 | `denoise_type: 'conv'` |
| 6-8 | < 10 | > 30 | > 5 | `denoise_type: 'attention'` |

**计算方法**:
```python
score = 0
if SNR < 10: score += 3
elif SNR < 20: score += 2

if 高频% > 30: score += 3
elif 高频% > 10: score += 2

if 异常值% > 5: score += 2
elif 异常值% > 1: score += 1
```

---

## 📝 实际案例分析

### 案例1: PEMS03 数据集

**可视化结果**:
```bash
$ python analyze_noise.py

📊 关键指标:
  • 平均信噪比: 18.32 dB
  • 高频能量占比: 15.67%
  • 异常值比例: 2.34%

🔍 诊断结果:
  ⚠️  SNR较低 (18.32 dB < 20 dB)
  ⚠️  高频噪声明显 (15.67% > 10%)
  ⚠️  有一定异常值 (2.34% > 1%)

💯 噪声评分: 5/8

💡 推荐方案:
🟡 数据有一定噪声，推荐使用卷积去噪
```

**配置**:
```yaml
use_denoising: True
denoise_type: 'conv'
```

---

### 案例2: 高质量数据

**可视化结果**:
```bash
📊 关键指标:
  • 平均信噪比: 24.56 dB
  • 高频能量占比: 7.23%
  • 异常值比例: 0.45%

🔍 诊断结果:
  ✅ SNR良好 (24.56 dB >= 20 dB)
  ✅ 高频噪声较少 (7.23% <= 10%)
  ✅ 异常值很少 (0.45% <= 1%)

💯 噪声评分: 0/8

💡 推荐方案:
🟢 数据质量良好，可以不使用去噪
```

**配置**:
```yaml
use_denoising: False
```

---

### 案例3: 低质量数据

**可视化结果**:
```bash
📊 关键指标:
  • 平均信噪比: 8.12 dB
  • 高频能量占比: 35.67%
  • 异常值比例: 6.78%

🔍 诊断结果:
  ❌ SNR过低 (8.12 dB < 10 dB)
  ❌ 高频噪声严重 (35.67% > 30%)
  ❌ 异常值过多 (6.78% > 5%)

💯 噪声评分: 8/8

💡 推荐方案:
🔴 数据噪声严重，强烈推荐使用注意力去噪
```

**配置**:
```yaml
use_denoising: True
denoise_type: 'attention'
```

---

## 🔄 完整工作流程

```
┌─────────────────────┐
│  1. 加载数据        │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  2. 快速可视化      │
│  visualize_raw_data │
└──────────┬──────────┘
           │
           ▼
      时间序列平滑？
      ┌────┴────┐
    是│         │否
      ▼         ▼
   可能不需   ┌─────────────────────┐
   要去噪     │  3. 深度噪声分析    │
              │  analyze_noise      │
              └──────────┬──────────┘
                         │
                         ▼
                   查看综合报告
                   ┌────┴────┐
              评分低│         │评分高
                   ▼         ▼
              不使用去噪  使用去噪
              └─────┬─────┴─────┐
                    │           │
                    ▼           ▼
              卷积去噪    注意力去噪
              └─────┬───────────┘
                    │
                    ▼
              ┌─────────────────────┐
              │  4. 对比实验        │
              │  训练并比较性能      │
              └──────────┬──────────┘
                         │
                         ▼
              ┌─────────────────────┐
              │  5. 选择最佳配置    │
              │  部署训练          │
              └─────────────────────┘
```

---

## 🛠️ 自定义分析

### 修改分析节点

编辑 `visualize_raw_data.py`:
```python
# 选择特定节点
sample_nodes = [0, 50, 100, 150, 200]

# 或随机选择
sample_nodes = np.random.choice(N, 10, replace=False)
```

### 调整时间窗口

```python
# 只显示前1000个时间步
time_window = 1000
```

### 调整SNR窗口大小

编辑 `analyze_noise.py`:
```python
# 使用更大的滑动窗口
snr_values = estimate_snr(data, window_size=100)
```

---

## 📊 输出文件总览

运行所有脚本后，`figure/` 目录包含:

```
figure/
├── raw_data_time_series.png      # 时间序列可视化
├── raw_data_distribution.png     # 数据分布分析
├── raw_data_correlation.png      # 节点相关性
└── noise_analysis_report.png     # 综合噪声分析（4合1）
```

---

## 💡 专业提示

### 1. 交通数据特点

交通流量数据通常包含:
- ✅ 日周期性（24小时）
- ✅ 周周期性（工作日vs周末）
- ✅ 传感器噪声
- ✅ 异常事件（事故、施工）

**建议**: 优先使用卷积去噪，保留周期性模式

### 2. 渐进式方法

```
Baseline (无去噪)
   ↓ 如果效果不佳
Conv去噪
   ↓ 如果还不满意
Attention去噪
```

### 3. 对比实验

**必须对比的指标**:
- 验证集 MAE/RMSE/MAPE
- 训练曲线稳定性
- 推理速度
- GPU内存占用

### 4. 保存中间结果

```python
# 在分析脚本中添加
np.save('snr_values.npy', snr_values)
```

---

## 🔗 相关文档

- [去噪模块详细指南](./DENOISING_MODULE.md)
- [快速参考](./DENOISING_QUICKSTART.md)
- [高级图学习](./ADVANCED_GRAPH_LEARNING.md)

---

## ❓ 常见问题

**Q: 分析需要多长时间？**
- 快速可视化: < 30秒
- 深度分析: < 1分钟

**Q: 可以分析其他数据集吗？**
是的，修改脚本中的 `dataset_name` 和 `mode`:
```python
dataset_name = 'PEMS04'  # 或 PEMS07, PEMS08
mode = 'train'  # 或 'val', 'test'
```

**Q: 图表太小看不清？**
调整 `figsize` 参数:
```python
fig, axes = plt.subplots(5, 1, figsize=(16, 15))  # 加大尺寸
```

**Q: 如何导出分析报告？**
```bash
python analyze_noise.py > noise_report.txt
```

---

**版本**: v1.0  
**更新时间**: 2025-11-15  
**作者**: AGPST Team
