# äº¤æ›¿æ¶æ„ä¸‰é˜¶æ®µæ¼”è¿›å¯¹æ¯”

## å®éªŒç»“æœæ€»ç»“

| Phase | ç­–ç•¥ | åˆå§‹ MAE | ç»“æœ | ç»“è®º |
|-------|------|---------|------|------|
| **Phase 1** | å›ºå®š2é˜¶æ®µäº¤æ›¿ | **~5.4** | âœ… æˆåŠŸ | **åŸºçº¿** |
| **Phase 2** | æ¸è¿›å¼ä¼˜åŒ– | | | |
| â”œâ”€ å‚æ•°å…±äº« | Stage1/2å…±äº«ç¼–ç å™¨ | ~6.9 | âŒ å¤±è´¥ | ä¸¤é˜¶æ®µä»»åŠ¡ä¸åŒ |
| â”œâ”€ è·³è·ƒè¿æ¥ | å¤šçº§æ®‹å·®è¿æ¥ | ~6.0+ | âŒ å¤±è´¥ | æ¢¯åº¦è·¯å¾„æ··ä¹± |
| â””â”€ æ‰¹å¤„ç†ä¼˜åŒ– | å‘é‡åŒ–ç©ºé—´ç¼–ç  | ~6.0+ | âŒ å¤±è´¥ | æ”¹å˜ç‰¹å¾å¤„ç†æ–¹å¼ |
| **Phase 3** | å¤šé˜¶æ®µå¾ªç¯ | **å¾…æµ‹è¯•** | ğŸš€ é©å‘½æ€§ | æœ¬è´¨æ”¹è¿› |

---

## Phase 1: å›ºå®šä¸¤é˜¶æ®µäº¤æ›¿ âœ…

### æ¶æ„
```
Input â†’ Embed
  â†“
Stage 1: Temporal Enc â†’ Spatial Enc â†’ Fusion
  â†“
Decoder: Split to temporal + spatial components
  â†“
Stage 2: Temporal Enc â†’ Spatial Enc â†’ Fusion
  â†“
Output Projection
```

### ç‰¹ç‚¹
- **ä¼˜åŠ¿**: æ¶æ„æ¸…æ™°ï¼Œæ€§èƒ½ç¨³å®š (åˆå§‹ MAE 5.4)
- **åŠ£åŠ¿**: å›ºå®šæ·±åº¦ï¼Œæ— æ³•è‡ªé€‚åº”è°ƒæ•´
- **å‚æ•°é‡**: ~1.23M
- **çŠ¶æ€**: âœ… **å·²éªŒè¯ï¼Œä½œä¸ºåŸºçº¿**

---

## Phase 2: æ¸è¿›å¼ä¼˜åŒ– âŒ 

### å¤±è´¥çš„ä¸‰ä¸ªä¼˜åŒ–

#### 1. å‚æ•°å…±äº« (Parameter Sharing)
```python
use_parameter_sharing: True
```
- **æ€è·¯**: Stage 1 å’Œ Stage 2 å…±äº«ç¼–ç å™¨ï¼Œå‡å°‘ 40% å‚æ•°
- **ç»“æœ**: åˆå§‹ MAE 6.9 (vs 5.4) âŒ
- **åŸå› **: 
  - Stage 1 å¤„ç†åŸå§‹è¾“å…¥
  - Stage 2 å¤„ç†è§£ç åçš„ç‰¹å¾
  - ä¸¤ä¸ªä»»åŠ¡æœ¬è´¨ä¸åŒï¼Œå¼ºåˆ¶å…±äº«é™åˆ¶è¡¨è¾¾èƒ½åŠ›

#### 2. è·³è·ƒè¿æ¥ (Skip Connections)
```python
use_skip_connections: True
skip_connection_type: 'add'  # or 'concat'
```
- **æ€è·¯**: å¤šçº§æ®‹å·®è¿æ¥ï¼Œç¼“è§£æ¢¯åº¦æ¶ˆå¤±
- **ç»“æœ**: åˆå§‹ MAE 6.0+ âŒ
- **åŸå› **:
  - æ¢¯åº¦ä¼ æ’­è·¯å¾„æ··ä¹±
  - æ¨¡å‹éš¾ä»¥å­¦ä¹ æ­£ç¡®çš„ç‰¹å¾å±‚æ¬¡
  - ç®€å•çš„è·³è·ƒè¿æ¥ä¸é€‚åˆäº¤æ›¿æ¶æ„

#### 3. æ‰¹å¤„ç†ä¼˜åŒ– (Batch Processing)
```python
batch_spatial_encoding: True
```
- **æ€è·¯**: å‘é‡åŒ–ç©ºé—´ç¼–ç ï¼ŒåŠ é€Ÿ 30%
- **ç»“æœ**: åˆå§‹ MAE 6.0+ âŒ
- **åŸå› **:
  - `_batch_spatial_encode` æ”¹å˜äº†ç‰¹å¾å¤„ç†æ–¹å¼
  - åŸæœ¬é€æ—¶é—´æ­¥ç¼–ç  â†’ æ‰¹é‡ç¼–ç 
  - å¯èƒ½ç ´åäº†æ—¶é—´åºåˆ—çš„å±€éƒ¨æ€§

### æ€»ç»“
Phase 2 çš„**æ‰€æœ‰ä¼˜åŒ–éƒ½å¤±è´¥**ï¼Œè¯´æ˜ï¼š
1. æ¸è¿›å¼å°ä¿®å°è¡¥æ— æ•ˆ
2. éœ€è¦æœ¬è´¨æ€§çš„æ¶æ„åˆ›æ–°
3. ç›´æ¥è·³åˆ° Phase 3

---

## Phase 3: å¤šé˜¶æ®µå¾ªç¯ ğŸš€ (é©å‘½æ€§æ”¹è¿›)

### æ ¸å¿ƒåˆ›æ–°

#### 1. å¤šé˜¶æ®µå¾ªç¯ (Multi-Stage Recurrence)
```python
num_stages: 3  # å¯é…ç½® 3-5
```
**å¯¹æ¯”**:
- Phase 1: å›ºå®š 2 é˜¶æ®µ
- Phase 3: å¾ªç¯ 3-5 é˜¶æ®µ (ç±»ä¼¼ ResNet æ·±åº¦æ®‹å·®)

**ä¼˜åŠ¿**:
- æ›´æ·±çš„ç‰¹å¾æå–
- è‡ªé€‚åº”å¾ªç¯æ·±åº¦
- æ¯ä¸ªé˜¶æ®µéƒ½æœ‰ç›‘ç£ä¿¡å·

#### 2. å¤šå°ºåº¦ç‰¹å¾é‡‘å­—å¡” (Multi-Scale Pyramid)
```python
patch_sizes: [1, 2, 4]
```
**ä¸åŒå°ºåº¦æ•è·ä¸åŒä¾èµ–**:
- Patch 1: ç»†ç²’åº¦ (çŸ­æœŸä¾èµ–ï¼Œæ•è·çªå‘å˜åŒ–)
- Patch 2: ä¸­ç²’åº¦ (ä¸­æœŸä¾èµ–ï¼Œæ•è·æ—¥å†…æ¨¡å¼)
- Patch 4: ç²—ç²’åº¦ (é•¿æœŸä¾èµ–ï¼Œæ•è·è¶‹åŠ¿)

**èåˆç­–ç•¥**:
```python
multi_scale = concat([patch1_feat, patch2_feat, patch4_feat])
fused = Linear(multi_scale)  # è‡ªé€‚åº”æƒé‡
```

#### 3. è·¨é˜¶æ®µæ³¨æ„åŠ› (Cross-Stage Attention)
```python
use_cross_stage_attention: True
```
**ç›¸æ¯” Phase 2 çš„è·³è·ƒè¿æ¥**:
- Phase 2: å›ºå®šæƒé‡ç›¸åŠ  `fused_2 = fused_2 + gate * skip_fused_1`
- Phase 3: åŠ¨æ€æ³¨æ„åŠ›æƒé‡ `attended = Attention(current, all_history)`

**ä¼˜åŠ¿**:
- åŠ¨æ€é€‰æ‹©å…³æ³¨å“ªäº›å†å²é˜¶æ®µ
- æ”¯æŒé•¿è·ç¦»ä¾èµ– (ç±»ä¼¼ Transformer)
- å¯è§£é‡Šæ€§æ›´å¼º

---

## Phase 3 æ¶æ„æµç¨‹

```
Input (B, T=12, N=207, C=1)
  â†“
Embedding: (B, N, T, D=96)
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 1:                            â”‚
â”‚  â”œâ”€ Multi-Scale Encoding            â”‚
â”‚  â”‚   â”œâ”€ Patch 1 (ç»†ç²’åº¦)            â”‚
â”‚  â”‚   â”œâ”€ Patch 2 (ä¸­ç²’åº¦)            â”‚
â”‚  â”‚   â””â”€ Patch 4 (ç²—ç²’åº¦)            â”‚
â”‚  â”œâ”€ Feature Fusion                  â”‚
â”‚  â””â”€ Decoder â†’ next stage input      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 2:                            â”‚
â”‚  â”œâ”€ Multi-Scale Encoding            â”‚
â”‚  â”œâ”€ Cross-Stage Attention           â”‚
â”‚  â”‚   â””â”€ Attend to Stage 1           â”‚
â”‚  â””â”€ Decoder â†’ next stage input      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 3:                            â”‚
â”‚  â”œâ”€ Multi-Scale Encoding            â”‚
â”‚  â”œâ”€ Cross-Stage Attention           â”‚
â”‚  â”‚   â””â”€ Attend to Stage 1, 2        â”‚
â”‚  â””â”€ Final Features                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
Output Projection: (B, T=12, N=207, C=1)
```

---

## é…ç½®å»ºè®®

### å¿«é€Ÿæµ‹è¯• (æ¨è)
```yaml
num_stages: 3
patch_sizes: [1, 2, 4]
use_cross_stage_attention: True
embed_dim: 96
batch_size: 32
lr: 0.0005
```

### æ·±åº¦æ¨¡å‹
```yaml
num_stages: 5  # æ›´å¤šå¾ªç¯
patch_sizes: [1, 2, 4, 8]  # æ›´å¤šå°ºåº¦
embed_dim: 128  # æ›´å¤§ç»´åº¦
```

### å¿«é€ŸåŸå‹
```yaml
num_stages: 2  # é€€åŒ–ä¸º Phase 1
patch_sizes: [1]  # å•å°ºåº¦
use_cross_stage_attention: False
```

---

## æœŸæœ›ç»“æœ

### æˆåŠŸæ ‡å‡†
| æŒ‡æ ‡ | Phase 1 | Phase 3 ç›®æ ‡ | è¯´æ˜ |
|------|---------|-------------|------|
| åˆå§‹ MAE | ~5.4 | **< 5.0** | æ›´å¥½çš„åˆå§‹åŒ– |
| æ”¶æ•› MAE | ~4.5 | **< 3.5** | æ›´å¼ºçš„è¡¨è¾¾èƒ½åŠ› |
| è®­ç»ƒæ—¶é—´ | 1x | ~2x | å¤šé˜¶æ®µä»£ä»·å¯æ¥å— |
| å‚æ•°é‡ | 1.23M | ~2-3M | 3 é˜¶æ®µçº¦ 2 å€å‚æ•° |

### å¤±è´¥åº”å¯¹
å¦‚æœ Phase 3 åˆå§‹ MAE > 5.4:
1. **é™ä½å¤æ‚åº¦**: `num_stages: 2`, `patch_sizes: [1]`
2. **è°ƒæ•´è¶…å‚**: æ›´å¤§ `lr`, æ›´å° `embed_dim`
3. **å›å½’ Phase 1**: æ”¾å¼ƒå¤šé˜¶æ®µï¼Œä¸“æ³¨è°ƒä¼˜ Phase 1

---

## å®éªŒè®¡åˆ’

### Step 1: å¿«é€ŸéªŒè¯ (1-2 epochs)
```bash
python main.py --cfg parameters/METR-LA_alternating_phase3.yaml --epochs 2
```
**è§‚å¯Ÿ**: åˆå§‹ MAE æ˜¯å¦ < 5.4

### Step 2: çŸ­æœŸè®­ç»ƒ (10 epochs)
å¦‚æœ Step 1 æˆåŠŸï¼Œè®­ç»ƒ 10 è½®çœ‹æ”¶æ•›è¶‹åŠ¿
```bash
python main.py --cfg parameters/METR-LA_alternating_phase3.yaml --epochs 10
```

### Step 3: å®Œæ•´è®­ç»ƒ (150 epochs)
å¦‚æœ Step 2 æ˜¾ç¤ºè‰¯å¥½æ”¶æ•›ï¼Œå®Œæ•´è®­ç»ƒ
```bash
python main.py --cfg parameters/METR-LA_alternating_phase3.yaml
```

### Step 4: æ¶ˆèç ”ç©¶
- `num_stages`: [2, 3, 4, 5]
- `patch_sizes`: [1], [1,2], [1,2,4], [1,2,4,8]
- `use_cross_stage_attention`: [True, False]

---

## æŠ€æœ¯ç»†èŠ‚

### å¤šå°ºåº¦ Patchify
```python
def _patchify(x, patch_size):
    # (B, N, T=12, D) with patch_size=2
    # â†’ (B, N, T//2=6, D*2)
    # â†’ Linear projection back to (B, N, 6, D)
    # â†’ Interpolate to (B, N, 12, D)
```

### è·¨é˜¶æ®µæ³¨æ„åŠ›
```python
# Stage 3 attending to Stage 1, 2
Query: stage_3_features  # (B, N*T, D)
Key/Value: concat([stage_1, stage_2])  # (B, 2*N*T, D)
Output: MultiheadAttention(Q, K, V)
```

### å‚æ•°é‡ä¼°ç®—
```
Phase 1 (2 stages): 
  2 * (TemporalEnc + SpatialEnc + Fusion) = ~1.23M

Phase 3 (3 stages, 3 scales):
  3 * 3 * (TemporalEnc + SpatialEnc) + CrossAttn
  â‰ˆ 9 * 0.2M + 0.5M â‰ˆ 2.3M
```

---

## ç»“è®º

âœ… **Phase 1**: ç¨³å®šåŸºçº¿ (MAE 5.4)  
âŒ **Phase 2**: æ‰€æœ‰ä¼˜åŒ–å¤±è´¥ (MAE 6.0+)  
ğŸš€ **Phase 3**: å¤šé˜¶æ®µå¾ªç¯ + å¤šå°ºåº¦ + è·¨é˜¶æ®µæ³¨æ„åŠ›

**ä¸‹ä¸€æ­¥**: ç›´æ¥æµ‹è¯• Phase 3ï¼Œå¦‚æœæˆåŠŸåˆ™å‘è¡¨è®ºæ–‡ï¼Œå¦‚æœå¤±è´¥åˆ™å›å½’ Phase 1 è°ƒä¼˜ã€‚
