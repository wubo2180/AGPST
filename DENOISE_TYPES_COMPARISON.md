# å»å™ªæ¨¡å—å¯¹æ¯”: Conv vs Attention

## ğŸ“Š ä¸¤ç§å»å™ªæ–¹å¼è¯¦è§£

äº¤æ›¿æ—¶ç©ºæ¶æ„æ”¯æŒä¸¤ç§å»å™ªç±»å‹,åœ¨è¾“å…¥åµŒå…¥åã€ç¼–ç å‰è¿›è¡Œå»å™ªå¤„ç†:

---

## 1ï¸âƒ£ å·ç§¯å»å™ª (Conv Denoising)

### å®ç°
```python
self.denoise = nn.Sequential(
    nn.Conv1d(embed_dim, embed_dim, kernel_size=3, padding=1),
    nn.GELU(),
    nn.Conv1d(embed_dim, embed_dim, kernel_size=3, padding=1),
)
```

### å·¥ä½œåŸç†
- **å±€éƒ¨å¹³æ»‘**: ä½¿ç”¨ 1D å·ç§¯åœ¨æ—¶é—´ç»´åº¦ä¸Šå¯¹æ¯ä¸ªèŠ‚ç‚¹çš„ç‰¹å¾è¿›è¡Œå¹³æ»‘
- **Kernel Size=3**: æ¯ä¸ªæ—¶é—´æ­¥èšåˆç›¸é‚» 3 ä¸ªæ—¶é—´æ­¥çš„ä¿¡æ¯
- **åŒå±‚å·ç§¯**: å¢å¼ºå»å™ªèƒ½åŠ›,æ‰©å¤§æ„Ÿå—é‡åˆ° 5 ä¸ªæ—¶é—´æ­¥

### å‰å‘è¿‡ç¨‹
```python
# è¾“å…¥: (B, N, T, D)
x_denoise = x.reshape(B*N, T, D).transpose(1, 2)  # â†’ (B*N, D, T)
x_denoise = self.denoise(x_denoise)                # Conv1d å»å™ª
x_denoise = x_denoise.transpose(1, 2).reshape(B, N, T, D)
x = x + x_denoise  # æ®‹å·®è¿æ¥
```

### ä¼˜åŠ¿
- âœ… **é€Ÿåº¦å¿«**: å·ç§¯æ“ä½œé«˜æ•ˆ,è®¡ç®—å¤æ‚åº¦ä½
- âœ… **å±€éƒ¨æœ‰æ•ˆ**: å¯¹çŸ­æœŸå™ªå£°å’Œçªå˜æ•æ„Ÿ
- âœ… **å‚æ•°å°‘**: åªæœ‰å·ç§¯æ ¸å‚æ•°
- âœ… **å¹³ç§»ä¸å˜æ€§**: å¯¹ä¸åŒæ—¶é—´æ­¥çš„å™ªå£°å¤„ç†ä¸€è‡´

### åŠ£åŠ¿
- âŒ **å±€éƒ¨æ„Ÿå—é‡**: åªèƒ½çœ‹åˆ°é‚»è¿‘æ—¶é—´æ­¥
- âŒ **éš¾ä»¥æ•è·é•¿ç¨‹ä¾èµ–**: æ— æ³•å»ºæ¨¡è¿œè·ç¦»çš„å™ªå£°æ¨¡å¼
- âŒ **å›ºå®šæƒé‡**: å¯¹ä¸åŒç±»å‹å™ªå£°çš„é€‚åº”æ€§æœ‰é™

### é€‚ç”¨åœºæ™¯
- âœ… é«˜é¢‘å™ªå£° (çªå˜ã€æŠ–åŠ¨)
- âœ… å±€éƒ¨å¼‚å¸¸å€¼
- âœ… å¯¹é€Ÿåº¦è¦æ±‚é«˜çš„åœºæ™¯
- âœ… è®­ç»ƒæ•°æ®è¾ƒå°‘æ—¶ (é¿å…è¿‡æ‹Ÿåˆ)

---

## 2ï¸âƒ£ æ³¨æ„åŠ›å»å™ª (Attention Denoising)

### å®ç°
```python
self.denoise = nn.MultiheadAttention(
    embed_dim=embed_dim,
    num_heads=num_heads,
    dropout=dropout,
    batch_first=True
)
self.denoise_norm = nn.LayerNorm(embed_dim)
```

### å·¥ä½œåŸç†
- **å…¨å±€å»ºæ¨¡**: ä½¿ç”¨ Self-Attention è®©æ¯ä¸ªæ—¶é—´æ­¥å…³æ³¨æ‰€æœ‰å…¶ä»–æ—¶é—´æ­¥
- **è‡ªé€‚åº”æƒé‡**: æ ¹æ®è¾“å…¥åŠ¨æ€è®¡ç®—æ³¨æ„åŠ›æƒé‡
- **å¤šå¤´æœºåˆ¶**: ä»å¤šä¸ªå­ç©ºé—´æ•è·ä¸åŒçš„å™ªå£°æ¨¡å¼

### å‰å‘è¿‡ç¨‹
```python
# è¾“å…¥: (B, N, T, D)
x_denoise = x.reshape(B*N, T, D)                   # â†’ (B*N, T, D)
x_attn, _ = self.denoise(x_denoise, x_denoise, x_denoise)  # Self-Attention
x_denoise = self.denoise_norm(x_denoise + x_attn)  # æ®‹å·® + å½’ä¸€åŒ–
x_denoise = x_denoise.reshape(B, N, T, D)
x = x + x_denoise
```

### ä¼˜åŠ¿
- âœ… **å…¨å±€è§†é‡**: å¯ä»¥å…³æ³¨ä»»æ„è·ç¦»çš„æ—¶é—´æ­¥
- âœ… **è‡ªé€‚åº”**: æ ¹æ®è¾“å…¥åŠ¨æ€è°ƒæ•´å»å™ªç­–ç•¥
- âœ… **å¼ºå¤§**: èƒ½æ•è·å¤æ‚çš„å™ªå£°æ¨¡å¼å’Œé•¿ç¨‹ä¾èµ–
- âœ… **å¤šå¤´æœºåˆ¶**: ä»ä¸åŒè§’åº¦è¯†åˆ«å’Œå¤„ç†å™ªå£°

### åŠ£åŠ¿
- âŒ **è®¡ç®—é‡å¤§**: O(TÂ²) å¤æ‚åº¦,æ—¶é—´æ­¥é•¿æ—¶è¾ƒæ…¢
- âŒ **å‚æ•°å¤š**: Q/K/V æŠ•å½±çŸ©é˜µ,å®¹æ˜“è¿‡æ‹Ÿåˆ
- âŒ **éœ€è¦æ›´å¤šæ•°æ®**: è®­ç»ƒè‡ªé€‚åº”æƒé‡éœ€è¦å……è¶³æ ·æœ¬
- âŒ **å¯èƒ½è¿‡å¹³æ»‘**: å…¨å±€æ³¨æ„åŠ›å¯èƒ½å‰Šå¼±å±€éƒ¨ç‰¹å¾

### é€‚ç”¨åœºæ™¯
- âœ… å¤æ‚å™ªå£°æ¨¡å¼ (éå¹³ç¨³ã€å¼‚è´¨æ€§)
- âœ… éœ€è¦é•¿ç¨‹ä¾èµ–å»ºæ¨¡
- âœ… è®­ç»ƒæ•°æ®å……è¶³
- âœ… å¯¹æ€§èƒ½è¦æ±‚é«˜äºé€Ÿåº¦

---

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

| ç»´åº¦ | Conv å»å™ª | Attention å»å™ª |
|------|----------|---------------|
| **é€Ÿåº¦** | â­â­â­â­â­ å¿« | â­â­â­ ä¸­ç­‰ |
| **å‚æ•°é‡** | â­â­â­â­â­ å°‘ | â­â­â­ ä¸­ç­‰ |
| **å»å™ªèƒ½åŠ›** | â­â­â­â­ å¥½ | â­â­â­â­â­ å¾ˆå¼º |
| **æ„Ÿå—é‡** | â­â­â­ å±€éƒ¨ | â­â­â­â­â­ å…¨å±€ |
| **è‡ªé€‚åº”æ€§** | â­â­â­ ä¸­ç­‰ | â­â­â­â­â­ å¼º |
| **è¿‡æ‹Ÿåˆé£é™©** | â­â­â­â­â­ ä½ | â­â­â­ ä¸­ç­‰ |

---

## ğŸ¯ ä½¿ç”¨å»ºè®®

### æ¨èé…ç½®

**å¿«é€ŸåŸå‹ / å°æ•°æ®é›†**:
```yaml
use_denoising: True
denoise_type: 'conv'  # æ¨è
```

**è¿½æ±‚æ€§èƒ½ / å¤§æ•°æ®é›†**:
```yaml
use_denoising: True
denoise_type: 'attention'  # æ¨è
```

**ä¸ç¡®å®šæ—¶**:
```yaml
use_denoising: True
denoise_type: 'conv'  # é»˜è®¤é€‰æ‹©,ç¨³å®šå¯é 
```

### å®éªŒå¯¹æ¯”

å»ºè®®å¯¹æ¯”ä¸¤ç§å»å™ªæ–¹å¼çš„æ•ˆæœ:

```bash
# å®éªŒ 1: Conv å»å™ª
python main.py --cfg parameters/METR-LA_alternating.yaml \
               --epochs 50 \
               # denoise_type: 'conv' (é…ç½®æ–‡ä»¶)

# å®éªŒ 2: Attention å»å™ª
python main.py --cfg parameters/METR-LA_alternating.yaml \
               --epochs 50 \
               # denoise_type: 'attention' (é…ç½®æ–‡ä»¶)

# å®éªŒ 3: æ— å»å™ª (å¯¹ç…§ç»„)
python main.py --cfg parameters/METR-LA_alternating.yaml \
               --epochs 50 \
               # use_denoising: False (é…ç½®æ–‡ä»¶)
```

**é¢„æœŸç»“æœ**:
```
æ— å»å™ª:           MAE ~5.5
Conv å»å™ª:        MAE ~5.2 (â¬‡ï¸ 5%)
Attention å»å™ª:   MAE ~5.0 (â¬‡ï¸ 9%)
```

---

## ğŸ’¡ ç»†èŠ‚è¯´æ˜

### Conv å»å™ªçš„æ„Ÿå—é‡

åŒå±‚ Conv1d (kernel_size=3):
```
Layer 1 æ„Ÿå—é‡: 3 æ—¶é—´æ­¥
Layer 2 æ„Ÿå—é‡: 5 æ—¶é—´æ­¥ (ç´¯ç§¯)
```

**å¯¹äº T=12 çš„è¾“å…¥**:
- ä¸­é—´æ—¶é—´æ­¥ (t=6) å¯ä»¥çœ‹åˆ° t=4 åˆ° t=8
- è¾¹ç•Œæ—¶é—´æ­¥ (t=0) å¯ä»¥çœ‹åˆ° t=0 åˆ° t=2

### Attention å»å™ªçš„æ³¨æ„åŠ›æ¨¡å¼

å‡è®¾ T=12, num_heads=4:
```python
æ¯ä¸ª head è®¡ç®—:
  Q = x @ W_q  # (B*N, 12, D/4)
  K = x @ W_k  # (B*N, 12, D/4)
  V = x @ W_v  # (B*N, 12, D/4)
  
  Attention = softmax(Q @ K^T / sqrt(D/4))  # (B*N, 12, 12)
  Output = Attention @ V  # (B*N, 12, D/4)
```

**æ³¨æ„åŠ›çŸ©é˜µ (12Ã—12)**:
- æ¯è¡Œæ˜¯ä¸€ä¸ªæ—¶é—´æ­¥å¯¹æ‰€æœ‰æ—¶é—´æ­¥çš„æ³¨æ„åŠ›æƒé‡
- å¯è§†åŒ–ä¼šå‘ç°:
  - å¹²å‡€æ•°æ®: å¯¹è§’çº¿é™„è¿‘æƒé‡é«˜ (å±€éƒ¨ç›¸å…³)
  - å™ªå£°æ•°æ®: åˆ†æ•£çš„æ³¨æ„åŠ›æ¨¡å¼ (å­¦ä¹ å»å™ªç­–ç•¥)

---

## ğŸ”¬ ç†è®ºåˆ†æ

### ä¸ºä»€ä¹ˆå»å™ªæœ‰æ•ˆ?

**äº¤é€šæ•°æ®çš„å™ªå£°æ¥æº**:
1. **ä¼ æ„Ÿå™¨å™ªå£°**: è®¾å¤‡è¯¯å·®ã€é€šä¿¡ä¸¢åŒ…
2. **å¼‚å¸¸äº‹ä»¶**: äº‹æ•…ã€æ–½å·¥ã€ç‰¹æ®Šå¤©æ°”
3. **æ•°æ®ç¼ºå¤±**: æ’å€¼äº§ç”Ÿçš„ä¼ªå™ªå£°
4. **äººä¸ºé”™è¯¯**: æ ‡æ³¨é”™è¯¯ã€ç³»ç»Ÿæ•…éšœ

**å»å™ªçš„ä½œç”¨**:
- å¹³æ»‘çªå˜ (Conv æ“…é•¿)
- ä¿®æ­£å¼‚å¸¸å€¼ (Attention æ“…é•¿)
- æ¢å¤ç¼ºå¤±æ¨¡å¼ (Attention æ“…é•¿)
- æå‡ç‰¹å¾è´¨é‡ â†’ æ›´å¥½çš„é¢„æµ‹

### ä½ç½®: ä¸ºä»€ä¹ˆåœ¨è¾“å…¥åµŒå…¥å?

```
Input â†’ Embedding â†’ ğŸ”¥ Denoise ğŸ”¥ â†’ Encoder â†’ ...
```

**åŸå› **:
1. **é«˜ç»´ç©ºé—´å»å™ªæ›´æœ‰æ•ˆ**: åµŒå…¥åç‰¹å¾ç»´åº¦é«˜ (D=96),ä¿¡æ¯æ›´ä¸°å¯Œ
2. **ä¿ç•™åŸå§‹ä¿¡æ¯**: å¯ä»¥é€šè¿‡æ®‹å·®è¿æ¥ä¿ç•™æœªè¢«å¹³æ»‘çš„æœ‰ç”¨ä¿¡å·
3. **é¿å…è¯¯å·®ä¼ æ’­**: æ—©æœŸå»å™ªå¯ä»¥é˜²æ­¢å™ªå£°åœ¨åç»­å±‚ä¸­æ”¾å¤§

---

## âœ… é…ç½®ç¤ºä¾‹

### METR-LA_alternating.yaml

**Conv å»å™ª (æ¨è,é»˜è®¤)**:
```yaml
use_denoising: True
denoise_type: 'conv'  # å¿«é€Ÿ,ç¨³å®š
```

**Attention å»å™ª (è¿½æ±‚æ€§èƒ½)**:
```yaml
use_denoising: True
denoise_type: 'attention'  # å¼ºå¤§,ä½†è¾ƒæ…¢
num_heads: 4  # å»å™ªç”¨çš„æ³¨æ„åŠ›å¤´æ•°
dropout: 0.1  # é˜²æ­¢è¿‡æ‹Ÿåˆ
```

**ç¦ç”¨å»å™ª**:
```yaml
use_denoising: False
```

---

## ğŸ“Š å®éªŒå»ºè®®

### å¿«é€ŸéªŒè¯

```bash
# 1. Conv å»å™ª (10 epochs)
python main.py --cfg parameters/METR-LA_alternating.yaml --epochs 10
# é¢„æœŸ: MAE ~5.2

# 2. Attention å»å™ª
# ä¿®æ”¹é…ç½®: denoise_type: 'attention'
python main.py --cfg parameters/METR-LA_alternating.yaml --epochs 10
# é¢„æœŸ: MAE ~5.0 (æ›´å¥½,ä½†å¯èƒ½æ…¢ 10-20%)

# 3. æ— å»å™ª
# ä¿®æ”¹é…ç½®: use_denoising: False
python main.py --cfg parameters/METR-LA_alternating.yaml --epochs 10
# é¢„æœŸ: MAE ~5.5 (å¯¹ç…§ç»„)
```

### å®Œæ•´å¯¹æ¯”

åœ¨å¤šä¸ªæ•°æ®é›†ä¸Šæµ‹è¯•:
- METR-LA (207 nodes)
- PEMS03 (358 nodes)
- PEMS04 (307 nodes)

**é¢„æœŸå‘ç°**:
- å°æ•°æ®é›† (METR-LA): Conv å’Œ Attention ç›¸è¿‘
- å¤§æ•°æ®é›† (PEMS03/04): Attention æ›´ä¼˜
- å™ªå£°å¤šçš„æ•°æ®: Attention ä¼˜åŠ¿æ˜æ˜¾

---

## ğŸ“ æ€»ç»“

| åœºæ™¯ | æ¨èæ–¹æ¡ˆ |
|------|---------|
| **é»˜è®¤é€‰æ‹©** | `denoise_type: 'conv'` |
| **è¿½æ±‚æ€§èƒ½** | `denoise_type: 'attention'` |
| **å¿«é€Ÿè®­ç»ƒ** | `denoise_type: 'conv'` |
| **æ•°æ®å……è¶³** | `denoise_type: 'attention'` |
| **æ•°æ®è¾ƒå°‘** | `denoise_type: 'conv'` |
| **æ—¶é—´æ­¥é•¿ (T>20)** | `denoise_type: 'conv'` (é¿å… O(TÂ²)) |
| **è°ƒè¯•/æ¶ˆè** | `use_denoising: False` |

**å»ºè®®**: å…ˆç”¨ `conv` å»ºç«‹åŸºçº¿,å¦‚æœæœ‰æ€§èƒ½éœ€æ±‚å†å°è¯• `attention`ã€‚
