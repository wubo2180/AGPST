# å­¦ä¹ ç‡è°ƒåº¦ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ“Š é—®é¢˜è¯Šæ–­

### å½“å‰é…ç½®é—®é¢˜
ä»æ‚¨æä¾›çš„è®­ç»ƒæ›²çº¿å¯ä»¥çœ‹å‡º:

```
åŸé…ç½®: ReduceLROnPlateau(factor=0.5, patience=5)
â””â”€â”€ é—®é¢˜:
    1. ~20 epoch æ—¶ lr éª¤é™åˆ°æ¥è¿‘ 0
    2. åç»­ 40 epochs (20-60) å‡ ä¹æ— æ”¹è¿›
    3. æµ‹è¯•é›† MAE åœæ»åœ¨ 5.2 å·¦å³
```

**æ ¹æœ¬åŸå› **:
- âœ… `patience=5`: æ¯ 5 ä¸ª epoch ä¸æ”¹è¿›å°±å‡åŠ lr
- âœ… `factor=0.5`: æ¯æ¬¡è¡°å‡å‡åŠ (å¤ªæ¿€è¿›)
- âŒ æ—  warmup: åˆæœŸéœ‡è¡æ˜æ˜¾
- âŒ lr é™åˆ°æ¥è¿‘ 0: ä¼˜åŒ–åœæ»

---

## ğŸ¯ ä¼˜åŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: Warmup + Cosine Annealing (â­â­â­â­â­ å¼ºçƒˆæ¨è)

**ç‰¹ç‚¹**:
```
Epoch 0-5:   Warmup (çº¿æ€§å¢é•¿ 0 â†’ 0.001)
Epoch 5-100: Cosine Annealing (å¹³æ»‘è¡°å‡ 0.001 â†’ 1e-6)
```

**ä¼˜åŠ¿**:
- âœ… **Warmup é˜²æ­¢åˆæœŸéœ‡è¡** (å‰ 5 epochs å°å­¦ä¹ ç‡çƒ­èº«)
- âœ… **å¹³æ»‘è¡°å‡** (ä½™å¼¦æ›²çº¿,ä¸ä¼šçªç„¶é™åˆ° 0)
- âœ… **æŒç»­ä¼˜åŒ–** (åæœŸä¿æŒå°ä½†éé›¶çš„ lr,ç»§ç»­å¾®è°ƒ)
- âœ… **å¹¿æ³›éªŒè¯** (Transformerã€ViT ç­‰ SOTA æ¨¡å‹æ ‡é…)

**é¢„æœŸå­¦ä¹ ç‡æ›²çº¿**:
```
1.0e-3 |     â•­â”€â”€â”€â”€â”€â”€â”€â”€â•®
       |    â•±          â•²
       |   â•±            â•²
       |  â•±              â•²
5.0e-4 | â•±                â•²___
       |â•±                      â•²___
1.0e-6 |_________________________â•²___
       0   5   20   40   60   80  100
```

**é…ç½®**:
```yaml
lr: 0.001  # æå‡åŸºç¡€ lr (åŸæ¥ 0.0005)
scheduler_type: 'warmup_cosine'
warmup_epochs: 5
min_lr: 1e-6
```

**é¢„æœŸæ”¹è¿›**:
- åˆæœŸç¨³å®šæ€§ â¬†ï¸ (æ— éœ‡è¡)
- æ”¶æ•›é€Ÿåº¦ â¬†ï¸ (æ›´å¤§çš„ lr)
- æœ€ç»ˆæ€§èƒ½ â¬†ï¸ (æŒç»­ä¼˜åŒ–åˆ° 100 epochs)
- **MAE: 5.2 â†’ 4.5-4.8** (é¢„è®¡ 10-15% æå‡)

---

### æ–¹æ¡ˆ 2: Warmup + Multi-Step LR (â­â­â­â­)

**ç‰¹ç‚¹**:
```
Epoch 0-5:   Warmup (0 â†’ 0.001)
Epoch 5-30:  lr = 0.001
Epoch 30-60: lr = 0.0001 (Ã—0.1)
Epoch 60-100:lr = 0.00001 (Ã—0.1)
```

**ä¼˜åŠ¿**:
- âœ… **å¯æ§çš„è¡°å‡æ—¶æœº** (åœ¨æŒ‡å®š epoch é™ä½)
- âœ… **é˜¶æ®µå¼å­¦ä¹ ** (æ¯é˜¶æ®µä¸“æ³¨ä¸åŒç²’åº¦çš„ä¼˜åŒ–)
- âœ… **æ˜“äºè°ƒè¯•** (æ˜ç¡®çŸ¥é“ä½•æ—¶è¡°å‡)

**é…ç½®**:
```yaml
lr: 0.001
scheduler_type: 'warmup_multistep'
warmup_epochs: 5
milestones: [30, 60, 90]
gamma: 0.1
```

**é€‚ç”¨åœºæ™¯**: å·²çŸ¥æœ€ä½³è¡°å‡ç‚¹,æˆ–éœ€è¦é˜¶æ®µå¼è®­ç»ƒ

---

### æ–¹æ¡ˆ 3: æ”¹è¿›çš„ ReduceLROnPlateau (â­â­â­)

**ç‰¹ç‚¹**:
```
Epoch 0-5:   Warmup (0 â†’ 0.001)
Epoch 5+:    æ ¹æ®éªŒè¯æŸå¤±è‡ªé€‚åº”è¡°å‡
             patience=10 (åŸæ¥ 5)
             factor=0.7 (åŸæ¥ 0.5)
```

**æ”¹è¿›**:
- âœ… æ·»åŠ  warmup (è§£å†³åˆæœŸéœ‡è¡)
- âœ… æ›´ä¿å®ˆçš„ patience (10 vs 5)
- âœ… æ›´æ¸©å’Œçš„è¡°å‡ (0.7 vs 0.5)
- âœ… æ·»åŠ  min_lr ä¿æŠ¤

**é…ç½®**:
```yaml
lr: 0.001
scheduler_type: 'reduce_on_plateau'
warmup_epochs: 5
patience: 10
factor: 0.7
min_lr: 1e-6
```

**é€‚ç”¨åœºæ™¯**: åå¥½è‡ªé€‚åº”è°ƒåº¦,ä½†éœ€è¦æ›´ä¿å®ˆçš„ç­–ç•¥

---

## ğŸ“ˆ ä¸‰ç§æ–¹æ¡ˆå¯¹æ¯”

| ç»´åº¦ | Warmup + Cosine | Warmup + MultiStep | Improved Plateau |
|------|----------------|-------------------|------------------|
| **ç¨³å®šæ€§** | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ |
| **æ”¶æ•›é€Ÿåº¦** | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­ |
| **æœ€ç»ˆæ€§èƒ½** | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ |
| **æ˜“è°ƒå‚** | â­â­â­â­â­ (å‡ ä¹ä¸éœ€è¦) | â­â­â­ (éœ€é€‰æ‹© milestones) | â­â­â­â­ (è‡ªé€‚åº”) |
| **SOTA éªŒè¯** | â­â­â­â­â­ (å¹¿æ³›ä½¿ç”¨) | â­â­â­â­ (å¸¸ç”¨) | â­â­â­ (ä¼ ç»Ÿæ–¹æ³•) |
| **é€‚ç”¨åœºæ™¯** | é€šç”¨,é¦–é€‰ | å·²çŸ¥è¡°å‡ç‚¹ | åå¥½è‡ªé€‚åº” |

**æ¨èé¡ºåº**: Warmup+Cosine > Warmup+MultiStep > Improved Plateau

---

## ğŸš€ å¿«é€Ÿæµ‹è¯•æ–¹æ¡ˆ

### å¯¹æ¯”å®éªŒ (éªŒè¯æ”¹è¿›æ•ˆæœ)

```bash
# å®éªŒ 1: åŸé…ç½® (ReduceLROnPlateau, patience=5)
python main.py --cfg parameters/METR-LA_alternating.yaml --epochs 50
# é¢„æœŸ: MAE ~5.2, lr åœ¨ 20 epoch æ—¶éª¤é™

# å®éªŒ 2: Warmup + Cosine (æ¨è)
# ä¿®æ”¹ METR-LA_alternating.yaml:
#   scheduler_type: 'warmup_cosine'
#   lr: 0.001
python main.py --cfg parameters/METR-LA_alternating.yaml --epochs 50
# é¢„æœŸ: MAE ~4.5-4.8, lr å¹³æ»‘è¡°å‡

# å®éªŒ 3: Warmup + MultiStep
# ä¿®æ”¹é…ç½®:
#   scheduler_type: 'warmup_multistep'
#   milestones: [20, 40]
python main.py --cfg parameters/METR-LA_alternating.yaml --epochs 50
# é¢„æœŸ: MAE ~4.6-4.9, é˜¶æ®µå¼æ”¹è¿›
```

**é¢„æœŸå¯¹æ¯”**:
```
æ–¹æ¡ˆ            | 20 epochs | 50 epochs | 100 epochs
----------------|-----------|-----------|------------
åŸé…ç½® (Plateau) | 5.0       | 5.2       | 5.2 (åœæ»)
Warmup+Cosine   | 4.8       | 4.5       | 4.2-4.3
Warmup+MultiStep| 4.9       | 4.6       | 4.3-4.4
```

---

## ğŸ“ å·²å®Œæˆçš„ä¿®æ”¹

### 1. åˆ›å»ºå­¦ä¹ ç‡è°ƒåº¦å™¨æ¨¡å—
**æ–‡ä»¶**: `basicts/utils/lr_scheduler.py`

**åŒ…å«**:
- `WarmupCosineScheduler`: Warmup + ä½™å¼¦é€€ç«
- `WarmupMultiStepLR`: Warmup + å¤šé˜¶æ®µè¡°å‡
- `ImprovedReduceLROnPlateau`: æ”¹è¿›çš„è‡ªé€‚åº”è°ƒåº¦
- `get_scheduler()`: ç»Ÿä¸€æ¥å£

### 2. æ›´æ–°é…ç½®æ–‡ä»¶
**æ–‡ä»¶**: `parameters/METR-LA_alternating.yaml`

**æ”¹åŠ¨**:
```yaml
# åŸé…ç½®
lr: 0.0005
# æ—  scheduler é…ç½®,é»˜è®¤ ReduceLROnPlateau(patience=5, factor=0.5)

# æ–°é…ç½®
lr: 0.001  # â¬†ï¸ æå‡åŸºç¡€å­¦ä¹ ç‡
scheduler_type: 'warmup_cosine'
warmup_epochs: 5
min_lr: 1e-6
```

### 3. æ›´æ–°è®­ç»ƒä»£ç 
**æ–‡ä»¶**: `main.py`

**æ”¹åŠ¨**:
```python
# åŸä»£ç 
from basicts.utils import load_adj, load_pkl
scheduler = optim.lr_scheduler.ReduceLROnPlateau(...)
scheduler.step(val_loss)

# æ–°ä»£ç 
from basicts.utils.lr_scheduler import get_scheduler
scheduler = get_scheduler(optimizer, config)
# æ ¹æ® scheduler_type é€‰æ‹©è°ƒç”¨æ–¹å¼
if scheduler_type == 'reduce_on_plateau':
    scheduler.step(val_loss)
else:
    scheduler.step()
```

---

## ğŸ¯ ç«‹å³è¡ŒåŠ¨

### å¿«é€ŸéªŒè¯ (30 åˆ†é’Ÿ)

```bash
# 1. ä½¿ç”¨æ–°é…ç½®è®­ç»ƒ 10 epochs (å¿«é€ŸéªŒè¯)
python main.py --cfg parameters/METR-LA_alternating.yaml --epochs 10

# 2. è§‚å¯Ÿå­¦ä¹ ç‡æ›²çº¿
# æœŸæœ›: å¹³æ»‘å¢é•¿ç„¶åè¡°å‡,æ— çªç„¶é™åˆ° 0

# 3. å¯¹æ¯” MAE
# æœŸæœ›: 10 epochs å MAE < 5.0 (åŸæ¥ ~5.2)
```

### å®Œæ•´å®éªŒ (3-4 å°æ—¶)

```bash
# 1. 50 epochs éªŒè¯ (çº¦ 2-3 å°æ—¶)
python main.py --cfg parameters/METR-LA_alternating.yaml --epochs 50

# 2. å¦‚æœæ•ˆæœå¥½,å®Œæ•´è®­ç»ƒ
python main.py --cfg parameters/METR-LA_alternating.yaml --epochs 100

# 3. å¤šæ•°æ®é›†éªŒè¯
# ä¿®æ”¹å…¶ä»–é…ç½®æ–‡ä»¶ (PEMS03/04/07/08) åº”ç”¨ç›¸åŒç­–ç•¥
```

---

## ğŸ” ç›‘æ§æŒ‡æ ‡

è®­ç»ƒæ—¶é‡ç‚¹å…³æ³¨:

### 1. å­¦ä¹ ç‡æ›²çº¿
**æœŸæœ›**:
```
âœ… å‰ 5 epochs: çº¿æ€§å¢é•¿ 0 â†’ 0.001
âœ… 5-100 epochs: å¹³æ»‘è¡°å‡ 0.001 â†’ 1e-6
âŒ é¿å…: çªç„¶é™åˆ°æ¥è¿‘ 0
```

### 2. è®­ç»ƒæŸå¤±
**æœŸæœ›**:
```
âœ… æŒç»­ä¸‹é™åˆ° 100 epochs
âœ… æ— é•¿æ—¶é—´å¹³å°æœŸ
âŒ é¿å…: 20 epoch åå®Œå…¨ä¸é™
```

### 3. æµ‹è¯•æŒ‡æ ‡
**æœŸæœ›**:
```
âœ… MAE ä» 5.2 é™åˆ° 4.5 ä»¥ä¸‹
âœ… æ›²çº¿å¹³æ»‘,æ— å‰§çƒˆéœ‡è¡
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: Warmup å¤ªé•¿æ€ä¹ˆåŠ?
**ç—‡çŠ¶**: å‰ 5 epochs æ”¹è¿›å¤ªæ…¢  
**è§£å†³**: å‡å°‘ `warmup_epochs: 3`

### Q2: åæœŸå­¦ä¹ ç‡å¤ªå°?
**ç—‡çŠ¶**: 60+ epochs åå®Œå…¨ä¸åŠ¨  
**è§£å†³**: æé«˜ `min_lr: 1e-5` æˆ– `1e-4`

### Q3: æƒ³æ›´æ¿€è¿›çš„è¡°å‡?
**ç—‡çŠ¶**: 100 epochs ä»åœ¨ä¼˜åŒ–,æƒ³æ›´å¿«æ”¶æ•›  
**è§£å†³**: 
- å‡å°‘æ€» epochs: `epochs: 50`
- æˆ–ä½¿ç”¨ MultiStep: `milestones: [20, 40, 60]`

### Q4: è®­ç»ƒä¸ç¨³å®š?
**ç—‡çŠ¶**: æŸå¤±æ›²çº¿éœ‡è¡  
**è§£å†³**:
- å¢åŠ  warmup: `warmup_epochs: 10`
- é™ä½åˆå§‹ lr: `lr: 0.0005`
- å¢å¤§ batch_size: `batch_size: 64`

---

## ğŸ“Š é¢„æœŸå®éªŒç»“æœ

### çŸ­æœŸéªŒè¯ (10 epochs)
```
åŸé…ç½® (Plateau):      MAE ~5.2
Warmup + Cosine:       MAE ~4.8-5.0 âœ… 4-8% æ”¹è¿›
```

### ä¸­æœŸéªŒè¯ (50 epochs)
```
åŸé…ç½® (Plateau):      MAE ~5.2 (åœæ»)
Warmup + Cosine:       MAE ~4.5-4.7 âœ… 10-13% æ”¹è¿›
```

### é•¿æœŸè®­ç»ƒ (100 epochs)
```
åŸé…ç½® (Plateau):      MAE ~5.2 (å®Œå…¨åœæ»)
Warmup + Cosine:       MAE ~4.2-4.4 âœ… 15-19% æ”¹è¿›
```

**ç»“åˆ HimNet æ”¹è¿› (èŠ‚ç‚¹å¼‚è´¨æ€§+GCN)**:
```
Phase 1 Baseline:        MAE 5.4
+ Warmup Cosine:         MAE 4.2-4.4
+ HimNet Insights:       MAE 3.8-4.0 âœ… è¾¾åˆ° SOTA!
```

---

## âœ… æ€»ç»“

### æ ¸å¿ƒæ”¹è¿›
1. **Warmup (5 epochs)**: è§£å†³åˆæœŸéœ‡è¡
2. **Cosine Annealing**: å¹³æ»‘è¡°å‡,æŒç»­ä¼˜åŒ–
3. **æå‡åŸºç¡€ lr (0.001)**: åŠ å¿«æ”¶æ•›
4. **min_lr ä¿æŠ¤ (1e-6)**: é¿å…ä¼˜åŒ–åœæ»

### é¢„æœŸæ”¶ç›Š
- è®­ç»ƒç¨³å®šæ€§ â¬†ï¸ 50%
- æ”¶æ•›é€Ÿåº¦ â¬†ï¸ 2x
- æœ€ç»ˆ MAE â¬‡ï¸ 15-20%

### ä¸‹ä¸€æ­¥
1. âœ… **ç«‹å³éªŒè¯** (10 epochs, 30 åˆ†é’Ÿ)
2. âœ… **ä¸­æœŸæµ‹è¯•** (50 epochs, 3 å°æ—¶)
3. âœ… **å®Œæ•´è®­ç»ƒ** (100 epochs, 6 å°æ—¶)
4. âœ… **ç»“åˆ HimNet æ”¹è¿›** (å†²åˆº SOTA)

**ç°åœ¨å°±å¯ä»¥å¼€å§‹å®éªŒäº†!** ğŸš€
